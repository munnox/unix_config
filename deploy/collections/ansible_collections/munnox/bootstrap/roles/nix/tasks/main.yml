---
# tasks file for nix

- name: set SELinux to permissive mode
  become: true
  ansible.builtin.shell: |
    setenforce permissive
  when: ansible_os_family == 'RedHat'

- name: Get Nix install script
  # become: true
  ansible.builtin.get_url:
    url: https://nixos.org/nix/install
    dest: "{{ (ansible_user_dir, 'nix_install.sh') | path_join }}"
    checksum: "sha256:4569a01dc5f62056f29f3195673bc3242fc70bf2474927fb5d8549c4d997402d."
    # owner: "{{ ansible_user }}"
    # group: "{{ ansible_user }}"
    mode: 0744
  register: nix_script

- name: Install Nix
  # become: true
  ansible.builtin.shell: |
    # Multiuser (recomended) Current version 2.6.1 @ 2022_02_25
    # sh "{{ nix_script.dest }}" --daemon
    # Single non privigled user
    sh "{{ nix_script.dest }}" --no-daemon
  args:
    creates: /nix

- name: Reset ssh connection to allow user changes to affect 'current login user'
  meta: reset_connection

- name: Get nix info from shell command
  register: nix_info
  changed_when: false
  ansible.builtin.shell: |
    source {{ ansible_user_dir}}/.bash_profile
    nix-shell -p nix-info --run 'nix-info -m'

- name: Show nix info
  ansible.builtin.debug:
    msg: |
      Run exit code : {{ nix_info.rc }}
      {{ nix_info.stdout }}